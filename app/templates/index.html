<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>NCPyVisual - Wersja Webowa (POPRAWIONA z konwersjƒÖ .bif/.zur) - Tryb Batch</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
  <style>
    html, body { height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:#f0f2f5; overflow:hidden; }
    .app { display:flex; flex-direction:column; height:100%; }
    .app__header { height:56px; background:#fff; border-bottom:1px solid #d9d9d9; display:flex; align-items:center; padding:0 16px; }
    .app__header h1 { font-size:1.25rem; margin:0; }
    .app__main { display:flex; flex:1; min-height:0; }
    .side { width:320px; background:#fafafa; border-right:1px solid #d9d9d9; padding:16px; overflow:auto; }
    .side h3 { margin:16px 0 8px; }
    .block { background:#fff; border:1px solid #e3e3e3; border-radius:8px; padding:12px; margin-bottom:12px; }
    .form-row { margin-bottom:10px; }
    .form-row label { display:block; font-weight:600; margin-bottom:4px; }
    .form-row input[type="text"], .form-row input[type="password"], .form-row input[type="number"] { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing: border-box; }
    .btn { width:100%; padding:10px; border:0; border-radius:8px; cursor:pointer; margin-top:6px; font-size:0.95rem; }
    .btn--primary { background:#007bff; color:#fff; }
    .btn--success { background:#28a745; color:#fff; }
    .btn--warn { background:#ffc107; color:#000; }
    .btn--danger { background:#dc3545; color:#fff; }
    .btn--muted { background:#6c757d; color:#fff; }
    .btn--debug { background:#17a2b8; color:#fff; }
    .content { flex:1; display:flex; align-items:center; justify-content:center; padding:16px; overflow:auto; background:#e9e9e9; }
    #image-canvas { background:#fff; box-shadow:0 4px 8px rgba(0,0,0,.08); }
    #loader { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.7); z-index:999; }
    .spinner { width:56px; height:56px; border-radius:50%; border:8px solid #eee; border-top-color:#3498db; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .gallery { max-height:220px; overflow:auto; border:1px solid #ddd; background:#fff; border-radius:6px; padding:6px; }
    .gallery img { width:100%; max-width:260px; margin:6px auto; display:block; cursor:pointer; border:2px solid transparent; border-radius:4px; }
    .gallery img:hover{ border-color:#3498db; }
    .gallery img.plate-result { border-color:#9c27b0; }
    input[type="file"]{ display:none; }
    .filelike { display:inline-block; width:100%; text-align:center; padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer; background:#f9f9f9; box-sizing: border-box; }
    .panel-title { margin-top:14px; border-top:2px solid #ddd; padding-top:10px; font-size:1.05rem; }
    pre { white-space:pre-wrap; word-wrap:break-word; background:#fff; border:1px solid #eee; border-radius:8px; padding:10px; max-height: 400px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px; }
    .result-summary { background:#e8f5e8; border:1px solid #4caf50; border-radius:6px; padding:8px; margin:8px 0; }
    .result-error { background:#ffe8e8; border:1px solid #f44336; border-radius:6px; padding:8px; margin:8px 0; }
    .result-info { background:#e3f2fd; border:1px solid #2196f3; border-radius:6px; padding:8px; margin:8px 0; }
    .plate-result { background:#e3f2fd; border-left:4px solid #2196f3; padding:8px; margin:4px 0; }
    .vehicle-result { background:#f3e5f5; border-left:4px solid #9c27b0; padding:8px; margin:4px 0; }
    .debug-info { background:#f8f9fa; border:1px solid #dee2e6; border-radius:6px; padding:8px; margin:8px 0; font-size:11px; }
    .status-ok { color: #28a745; font-weight: bold; }
    .status-error { color: #dc3545; font-weight: bold; }
    .status-warn { color: #ffc107; font-weight: bold; }
    .format-label { position:absolute; top:2px; left:2px; background:rgba(0,0,0,0.7); color:white; padding:2px 4px; font-size:10px; border-radius:2px; }
    .conversion-info { background:#e3f2fd; border:1px solid #2196f3; border-radius:6px; padding:8px; margin:8px 0; font-size:12px; }
    .image-container { position:relative; display:inline-block; margin:6px; }
  </style>
</head>
<body>
<div id="loader"><div class="spinner"></div></div>
<div class="app">
  <header class="app__header"><h1>NCPyVisual üîß (POPRAWIONA z konwersjƒÖ .bif/.zur ‚Üí .jpg) - Tryb Batch</h1></header>
  <main class="app__main">
    <aside class="side">

        <div class="block">
          <h3>1) Import z terminala</h3>
          <div class="form-row">
            <label for="device-ip">Adres IP terminala</label>
            <input id="device-ip" type="text" placeholder="np. 172.16.3.13">
          </div>
          <div class="form-row">
            <label for="device-pass">Has≈Ço (root)</label>
            <input id="device-pass" type="password" placeholder="je≈õli wymagane">
          </div>
          <button id="btn-import" class="btn btn--primary">Pobierz konfiguracjƒô</button>
        </div>

        <div class="block">
          <h3>2) Najnowsze zdjƒôcia (z konwersjƒÖ)</h3>
          <div class="form-row">
            <label for="image-count">Ilo≈õƒá</label>
            <input id="image-count" type="number" min="1" max="100" value="10">
          </div>
          <button id="btn-fetch" class="btn btn--primary">Pobierz i wy≈õwietl</button>
          <div class="conversion-info" style="display:none;" id="conversion-info">
            <strong>üîÑ Konwersja obraz√≥w:</strong><br>
            Obs≈Çugiwane formaty: .jpg, .jpeg, .bif, .zur<br>
            Wszystkie konwertowane na JPEG dla NCShot
          </div>
          <div id="gallery" class="gallery"></div>
        </div>

        <div class="block">
          <h3>Obraz & ROI</h3>
          <label for="image-input" class="filelike">Wczytaj obraz (.jpg/.png)</label>
          <input id="image-input" type="file" accept=".jpg,.jpeg,.png">
          <label for="xml-input" class="filelike" style="margin-top:6px;">Wczytaj ROI z XML</label>
          <input id="xml-input" type="file" accept=".xml">
          <button id="btn-draw" class="btn">Rysuj ROI</button>
          <button id="btn-clear" class="btn btn--muted">Wyczy≈õƒá ROI</button>
        </div>

      <div class="block">
        <h3>3) Konfiguracja / eksport</h3>
        <div class="form-row"><label for="serial-number">Numer seryjny</label><input id="serial-number" type="text" placeholder="np. 593-072-73194"></div>
        <div class="form-row"><label for="location-id">ID Lokalizacji</label><input id="location-id" type="text" placeholder="np. WSC.3.069"></div>
        <div class="form-row"><label for="gps-lat">Szer. geogr.</label><input id="gps-lat" type="text" placeholder="51.2533333"></div>
        <div class="form-row"><label for="gps-lon">D≈Ç. geogr.</label><input id="gps-lon" type="text" placeholder="22.5478611"></div>
        <div class="panel-title">Zaawansowane</div>
        <div class="form-row"><label for="backend-addr">Adres fotoradaru</label><input id="backend-addr" type="text" placeholder="np. 172.20.2.23"></div>
        <div class="form-row"><label for="swdallow-masks">SWD Allow</label><input id="swdallow-masks" type="text" placeholder="172.16.0.0/24 ..."></div>
        <div class="form-row"><label for="nativeallow-masks">Native Allow</label><input id="nativeallow-masks" type="text" placeholder="0.0.0.0/0"></div>
        <button id="btn-package" class="btn btn--success">Generuj pakiet</button>
      </div>

      <div id="panel-props" class="block" style="display:none;">
        <h3>W≈Ça≈õciwo≈õci ROI</h3>
        <div class="form-row"><label for="roi-id">ID</label><input id="roi-id" type="text" readonly></div>
        <div class="form-row"><label>KƒÖt</label><input class="param-input" data-param="angle" id="param-angle" type="number" step="0.1"></div>
        <div class="form-row"><label>Zoom</label><input class="param-input" data-param="zoom" id="param-zoom" type="number" step="0.01"></div>
        <div class="form-row"><label>Offset H</label><input class="param-input" data-param="reflexOffsetH" id="param-oh" type="number"></div>
        <div class="form-row"><label>Offset V</label><input class="param-input" data-param="reflexOffsetV" id="param-ov" type="number"></div>
        <div class="form-row"><label>Skew H</label><input class="param-input" data-param="skewH" id="param-sh" type="number" step="0.01"></div>
        <div class="form-row"><label>Skew V</label><input class="param-input" data-param="skewV" id="param-sv" type="number" step="0.01"></div>
        <button id="btn-edit" class="btn btn--warn">Edytuj kszta≈Çt</button>
        <button id="btn-verify" class="btn btn--primary">üî¨ Testuj ROI z NCSim (opcjonalne)</button>
        <button id="btn-ncshot" class="btn btn--success">üöÄ Uruchom NCShot (G≈Å√ìWNA FUNKCJA z konwersjƒÖ)</button>
        <button id="btn-debug" class="btn btn--debug">üõ† Debug NCShot</button>
        <button id="btn-del" class="btn btn--danger">Usu≈Ñ ROI</button>
      </div>

      <div id="panel-verify" class="block" style="display:none;">
        <h3>Wyniki przetwarzania</h3>
        <div id="verify-summary"></div>
        <pre id="verify-out"></pre>
      </div>

    </aside>
    <section class="content">
      <canvas id="image-canvas"></canvas>
    </section>
  </main>
</div>

<script>
  const notyf = new Notyf({ duration: 4000, position: { x:'right', y:'top' }});
  let canvas, drawing=false, editPoly=null, tmpPts=[], tmpDots=[], roiCount=0;

  const roiColors = [
    { fill:'rgba(0,255,0,.3)', stroke:'green' },
    { fill:'rgba(255,255,0,.3)', stroke:'orange' },
    { fill:'rgba(255,0,255,.3)', stroke:'magenta' },
    { fill:'rgba(0,255,255,.3)', stroke:'cyan' },
    { fill:'rgba(255,165,0,.3)', stroke:'darkorange' },
  ];

  const $ = (id)=>document.getElementById(id);
  const $loader = $('loader');
  const showLoader = ()=> $loader.style.display='flex';
  const hideLoader = ()=> $loader.style.display='none';

  document.addEventListener('DOMContentLoaded', ()=>{
    canvas = new fabric.Canvas('image-canvas');
    bindUI();
    
    // Poka≈º informacje o konwersji
    $('conversion-info').style.display = 'block';
  });

  function bindUI(){
    $('btn-import').onclick = importFromDevice;
    $('btn-fetch').onclick = fetchImages;
    $('btn-package').onclick = generatePackage;
    $('btn-draw').onclick = startDraw;
    $('btn-clear').onclick = clearRoi;
    $('btn-edit').onclick = toggleEdit;
    $('btn-del').onclick = ()=> deleteRoi(true);
    $('btn-verify').onclick = verifyScene;
    $('btn-ncshot').onclick = runNcshot;
    $('btn-debug').onclick = debugNcshot;

    $('image-input').onchange = loadImage;
    $('xml-input').onchange = loadXml;

    canvas.on('mouse:down', onMouseDown);
    canvas.on('selection:created', onSelect);
    canvas.on('selection:updated', onSelect);
    canvas.on('selection:cleared', onClearSel);

    document.querySelectorAll('.param-input').forEach(inp=>{
      inp.addEventListener('input', onParamChange);
    });

    document.addEventListener('keydown', (e)=>{
      if(document.activeElement.tagName==='INPUT') return;
      if(e.key==='Delete' || e.key==='Backspace') deleteRoi(false);
    });

    const cc = document.querySelector('.canvas-container');
    if(cc) cc.addEventListener('contextmenu', (e)=>{ e.preventDefault(); if(drawing) finishPolygon(); });
  }

  function loadImage(ev){
    const f = ev.target.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);
    canvas.setBackgroundImage(url, canvas.renderAll.bind(canvas));
    const img = new Image(); img.src = url;
    img.onload = ()=>{ canvas.setWidth(img.width); canvas.setHeight(img.height); canvas.renderAll(); URL.revokeObjectURL(url); };
  }

  function startDraw(){
    if(editPoly) toggleEdit();
    drawing = true; canvas.selection = false;
    $('btn-draw').disabled = true; $('btn-draw').textContent = 'Rysowanie‚Ä¶ (PPM ko≈Ñczy)';
  }

  function onMouseDown(opt){
    if(!drawing) return;
    if(opt.e.button !== 0) return;
    const p = canvas.getPointer(opt.e);
    tmpPts.push({x:p.x, y:p.y});
    const dot = new fabric.Circle({ left:p.x, top:p.y, radius:3, fill:'red', selectable:false, originX:'center', originY:'center' });
    canvas.add(dot); tmpDots.push(dot); canvas.renderAll();
  }

  function finishPolygon(){
    if(tmpPts.length < 3){ resetDraw(); return; }
    const color = roiColors[roiCount % roiColors.length]; roiCount++;
    const poly = new fabric.Polygon(tmpPts, {
      fill: color.fill, stroke: color.stroke, strokeWidth:2, selectable:true, hasControls:true,
      customData: { id:`ROI-${roiCount}`, angle:0, zoom:1, reflexOffsetH:0, reflexOffsetV:0, skewH:0, skewV:0 }
    });
    canvas.add(poly); resetDraw();
  }

  function resetDraw(){
    tmpDots.forEach(d=>canvas.remove(d)); tmpDots=[]; tmpPts=[]; drawing=false; canvas.selection = true;
    $('btn-draw').disabled=false; $('btn-draw').textContent='Rysuj ROI'; canvas.renderAll();
  }

  function onSelect(e){
    if(editPoly) toggleEdit();
    const o = e.selected[0];
    if(o && o.customData){
      $('panel-props').style.display='block';
      $('roi-id').value = o.customData.id || '';
      document.querySelectorAll('.param-input').forEach(inp=>{
        const k = inp.dataset.param; inp.value = o.customData[k] ?? 0;
      });
    } else $('panel-props').style.display='none';
  }
  function onClearSel(){ if(editPoly) toggleEdit(); $('panel-props').style.display='none'; }
  function onParamChange(e){
    const o = canvas.getActiveObject(); if(!(o&&o.customData)) return;
    const k = e.target.dataset.param; o.customData[k] = parseFloat(e.target.value) || 0;
  }

  function deleteRoi(confirmFirst){
    const o = canvas.getActiveObject(); if(!o){ if(confirmFirst) notyf.error('Nie zaznaczono ROI'); return; }
    if(confirmFirst && !confirm(`UsunƒÖƒá ${o.customData.id}?`)) return;
    canvas.remove(o); notyf.success('Usuniƒôto ROI'); canvas.renderAll();
  }

  function toggleEdit(){
    const btn = $('btn-edit');
    if(editPoly){
      editPoly.edit = false; canvas.setActiveObject(editPoly); btn.textContent='Edytuj kszta≈Çt'; btn.className='btn btn--warn';
      editPoly = null; canvas.renderAll();
    } else {
      const o = canvas.getActiveObject();
      if(!(o && o.type==='polygon')){ notyf.error('Zaznacz poligon'); return; }
      editPoly = o; editPoly.edit = true; btn.textContent='Zatwierd≈∫'; btn.className='btn btn--primary';
      canvas.setActiveObject(editPoly); canvas.renderAll();
    }
  }

  function clearRoi(){
    if(!confirm('Wyczy≈õciƒá wszystkie ROI?')) return;
    canvas.getObjects().filter(o=>o.customData).forEach(o=>canvas.remove(o)); roiCount=0; canvas.renderAll(); notyf.success('Wyczyszczono ROI');
  }

  function roisOut(){
    return canvas.getObjects().filter(o=>o.customData).map(o=>({ ...o.customData, points:o.points }));
  }

  async function generatePackage(){
    if(editPoly) toggleEdit();
    const rois = roisOut();
    if(!rois.length) return notyf.error('Brak ROI');

    const deployment = {
      serialNumber:$('serial-number').value,
      locationId:$('location-id').value,
      gpsLat:$('gps-lat').value,
      gpsLon:$('gps-lon').value,
      backendAddr:$('backend-addr').value,
      swdallowMasks:$('swdallow-masks').value,
      nativeallowMasks:$('nativeallow-masks').value
    };
    if(!deployment.locationId) return notyf.error('Wymagane ID lokalizacji');

    showLoader();
    try{
      const res = await fetch('/generate-package/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ rois, deployment })
      });
      if(!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'B≈ÇƒÖd serwera');
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url;
      a.download=`ncpy_package_${deployment.locationId}_${new Date().toISOString().slice(0,10)}.zip`;
      a.click();
      URL.revokeObjectURL(url);
      notyf.success('Pobrano pakiet');
    }catch(e){
      notyf.error(e.message);
    }finally{
      hideLoader();
    }
  }

  async function importFromDevice(){
    const ip=$('device-ip').value, password=$('device-pass').value;
    if(!ip) return notyf.error('Podaj IP terminala');
    showLoader();
    try{
      const res = await fetch('/import-from-device/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ ip, password })
      });
      if(!res.ok){
        const e=await res.json();
        throw new Error(e.detail || 'B≈ÇƒÖd importu');
      }
      const data = await res.json();

      $('serial-number').value = data.serialNumber || '';
      $('location-id').value = data.locationId || '';
      $('gps-lat').value = data.gpsLat || '';
      $('gps-lon').value = data.gpsLon || '';
      $('backend-addr').value = data.backendAddr || '';
      $('swdallow-masks').value = data.swdallowMasks || '';
      $('nativeallow-masks').value = data.nativeallowMasks || '';

      if(data.rois && data.rois.length){
        drawRois(data.rois);
        notyf.success(`Zaimportowano konfiguracjƒô z ${ip}`);
      } else {
        canvas.getObjects().filter(o=>o.customData).forEach(o=>canvas.remove(o));
        canvas.renderAll();
        notyf.success('Brak ROI na urzƒÖdzeniu, wyczyszczono.');
      }
    }catch(e){
      notyf.error(e.message);
    }finally{
      hideLoader();
    }
  }

  function drawRois(list){
    canvas.getObjects().filter(o=>o.customData).forEach(o=>canvas.remove(o));
    list.forEach((r,i)=>{
      const color = roiColors[i % roiColors.length];
      const points = (r.points && r.points.length) ? r.points : [{x:40+i*10,y:40+i*10},{x:160+i*10,y:40+i*10},{x:160+i*10,y:160+i*10},{x:40+i*10,y:160+i*10}];
      const cd = {...r}; delete cd.points;
      const poly = new fabric.Polygon(points, {
        fill:color.fill,
        stroke:color.stroke,
        strokeWidth:2,
        selectable:true,
        hasControls:true,
        customData:cd
      });
      canvas.add(poly);
    });
    roiCount = list.length; canvas.renderAll();
  }

  async function fetchImages(){
    const ip=$('device-ip').value, password=$('device-pass').value, count=parseInt($('image-count').value||'1',10);
    if(!ip) return notyf.error('Podaj IP terminala');
    $('gallery').innerHTML='';
    showLoader();
    try{
      const res = await fetch('/fetch-device-images/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ ip, password, count })
      });
      if(!res.ok){
        const e=await res.json();
        throw new Error(e.detail || 'B≈ÇƒÖd');
      }
      const data = await res.json();
      if(data.images && data.images.length){
        notyf.success(`Pobrano ${data.images.length} zdjƒôƒá`);
        
        // Dodaj informacje o konwersji
        let jpegCount = 0, bifCount = 0, zurCount = 0;
        
        data.images.forEach(it=>{
          // Stw√≥rz kontener dla obrazu z etykietƒÖ formatu
          const container = document.createElement('div');
          container.className = 'image-container';
          
          const img = document.createElement('img');
          img.src = it.data;
          img.title = `${it.filename}\nFormat oryginalny: ${it.original_format || 'nieznany'}\nRozmiar JPEG: ${it.size || 'nieznany'} bajt√≥w\nKonwertowane na JPEG dla NCShot`;
          
          // Dodaj etykietƒô formatu
          const formatLabel = document.createElement('div');
          formatLabel.className = 'format-label';
          formatLabel.textContent = (it.original_format || '.jpg').toUpperCase().replace('.', '');
          
          container.appendChild(img);
          container.appendChild(formatLabel);
          
          img.onclick = ()=>{
            canvas.setBackgroundImage(img.src, canvas.renderAll.bind(canvas));
            const i = new Image();
            i.src = img.src;
            i.onload = ()=>{
              canvas.setWidth(i.width);
              canvas.setHeight(i.height);
            };
            notyf.success(`Za≈Çadowano: ${it.filename} (${it.original_format || 'JPEG'})`);
          };
          $('gallery').appendChild(container);
          
          // Zlicz formaty
          switch(it.original_format) {
            case '.jpg':
            case '.jpeg':
              jpegCount++;
              break;
            case '.bif':
              bifCount++;
              break;
            case '.zur':
              zurCount++;
              break;
          }
        });
        
        // Poka≈º statystyki konwersji
        if(bifCount > 0 || zurCount > 0) {
          const stats = [];
          if(jpegCount > 0) stats.push(`${jpegCount} JPEG`);
          if(bifCount > 0) stats.push(`${bifCount} BIF`);
          if(zurCount > 0) stats.push(`${zurCount} ZUR`);
          
          const conversionMsg = `Formaty: ${stats.join(', ')}. Wszystkie skonwertowane na JPEG dla NCShot.`;
          
          const infoDiv = document.createElement('div');
          infoDiv.className = 'conversion-info';
          infoDiv.innerHTML = `<strong>üîÑ Konwersja obraz√≥w:</strong><br>${conversionMsg}`;
          $('gallery').insertBefore(infoDiv, $('gallery').firstChild);
          
          notyf.success(`Konwersja: ${bifCount + zurCount} obraz√≥w BIF/ZUR ‚Üí JPEG`);
        }
        
      } else {
        notyf.success('Brak zdjƒôƒá na urzƒÖdzeniu.');
      }
    }catch(e){
      notyf.error(e.message);
    }finally{
      hideLoader();
    }
  }

  async function loadXml(ev){
    const f = ev.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = async (e)=>{
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
        const roisFromXml = [];
        const roiNodes = xmlDoc.getElementsByTagName("roi");
        for (let i = 0; i < roiNodes.length; i++) {
            const node = roiNodes[i];
            const pointsStr = node.getElementsByTagName("points")[0]?.textContent || '';
            const points = pointsStr.split(';').map(p => ({
              x: parseFloat(p.split(',')[0]),
              y: parseFloat(p.split(',')[1])
            }));
            roisFromXml.push({
                id: node.getAttribute("id"),
                points: points,
                angle: parseFloat(node.getElementsByTagName("angle")[0]?.textContent || 0),
                zoom: parseFloat(node.getElementsByTagName("zoom")[0]?.textContent || 1),
                reflexOffsetH: parseInt(node.getElementsByTagName("reflexOffsetH")[0]?.textContent || 0, 10),
                reflexOffsetV: parseInt(node.getElementsByTagName("reflexOffsetV")[0]?.textContent || 0, 10),
                skewH: parseFloat(node.getElementsByTagName("skewH")[0]?.textContent || 0),
                skewV: parseFloat(node.getElementsByTagName("skewV")[0]?.textContent || 0),
            });
        }
        if(roisFromXml.length > 0){
            drawRois(roisFromXml);
            notyf.success(`Wczytano ${roisFromXml.length} ROI z pliku XML.`);
        } else {
            notyf.error('Nie znaleziono ROI w pliku XML.');
        }
    };
    reader.readAsText(f);
  }

  function formatVerificationResults(results) {
    let summaryHtml = '';
    let detailsText = '';

    if (results.verification_type === 'ncsim_verification') {
      const sim_results = results.results;
      
      // Sprawd≈∫ czy to b≈ÇƒÖd sk≈Çadni
      if (sim_results.error && (sim_results.error.includes("sk≈Çadni") || sim_results.error.includes("INFORMACJA"))) {
        summaryHtml = `
          <div class="result-info">
            <strong>‚ÑπÔ∏è INFORMACJA O NCSIM (WERYFIKACJA OPCJONALNA)</strong><br>
            <span class="status-warn">‚ö†Ô∏è NCSim wymaga dodatkowych plik√≥w sk≈Çadni (.bin)</span><br>
            <span class="status-ok">‚úÖ <strong>NCShot (g≈Ç√≥wna funkcja) dzia≈Ça poprawnie</strong></span><br>
            üìã NCSim s≈Çu≈ºy tylko do weryfikacji - nie wp≈Çywa na dzia≈Çanie NCShot<br>
            üéØ <strong>U≈ºywaj przycisku "üöÄ Uruchom NCShot" dla pe≈Çnego przetwarzania obraz√≥w</strong>
          </div>`;
        
        detailsText = `=== INFORMACJA O FUNKCJONALNO≈öCIACH ===

üöÄ NCShot to G≈Å√ìWNA FUNKCJONALNO≈öƒÜ aplikacji i dzia≈Ça poprawnie.
üî¨ NCSim to tylko narzƒôdzie weryfikacyjne, kt√≥re wymaga dodatkowych plik√≥w sk≈Çadni.

Szczeg√≥≈Çy techniczne:
${sim_results.error}

Dostƒôpne pliki sk≈Çadni: XML w /neurocar/etc/syntax/
Wymagane przez NCSim: Skompilowane pliki .bin

=== ZALECENIE ===
U≈ºywaj funkcji "üöÄ Uruchom NCShot" do przetwarzania obraz√≥w.
NCShot nie wymaga dodatkowych plik√≥w sk≈Çadni.
`;
      
      } else if (sim_results.processing_successful) {
        // NCSim zadzia≈Ça≈Ç poprawnie
        summaryHtml = `
          <div class="result-summary">
            <strong>üìä WYNIKI WERYFIKACJI NCSIM</strong><br>
            <span class="status-ok">‚úÖ Rozpoznanie Silne: <strong>${sim_results.recog_strong !== null ? sim_results.recog_strong.toFixed(2) + '%' : 'N/A'}</strong></span><br>
            <span class="status-ok">‚òëÔ∏è Rozpoznanie S≈Çabe: <strong>${sim_results.recog_weak !== null ? sim_results.recog_weak.toFixed(2) + '%' : 'N/A'}</strong></span><br>
            ‚öôÔ∏è Metoda: ${results.processing_method}<br>
            ‚è±Ô∏è Czas: ${sim_results.processing_time || 'N/A'}<br>
            <span class="status-ok">üí° <strong>NCShot dostƒôpny do pe≈Çnego przetwarzania</strong></span>
          </div>`;

        detailsText = `=== WYNIKI WERYFIKACJI NCSIM ===

Pe≈Çny wynik z terminala:
--------------------------
${sim_results.ncsim_output || 'Brak danych wyj≈õciowych z ncsim.'}
--------------------------

‚úÖ Weryfikacja zako≈Ñczona pomy≈õlnie.
üéØ Przejd≈∫ do NCShot dla pe≈Çnego przetwarzania obraz√≥w z generowaniem p≈Çytek.
`;
      
      } else {
        // Inny b≈ÇƒÖd NCSim
        summaryHtml = `
          <div class="result-error">
            <strong>‚ö†Ô∏è PROBLEM Z NCSIM (WERYFIKACJA OPCJONALNA)</strong><br>
            <span class="status-error">${sim_results.error || 'Nieznany problem'}</span><br>
            <span class="status-ok">‚úÖ <strong>NCShot (g≈Ç√≥wna funkcja) pozostaje dostƒôpny</strong></span>
          </div>`;
        
        detailsText = `=== PROBLEM Z NCSIM (WERYFIKACJA) ===

B≈ÇƒÖd: ${sim_results.error || 'Nieznany problem'}

Wyj≈õcie:
${sim_results.ncsim_output || 'Brak szczeg√≥≈Ç√≥w'}

=== WA≈ªNE ===
NCShot jest g≈Ç√≥wnƒÖ funkcjonalno≈õciƒÖ i dzia≈Ça niezale≈ºnie od NCSim.
NCSim to tylko opcjonalna weryfikacja konfiguracji ROI.
`;
      }

    } else {
        summaryHtml = `<div class="result-error">Nieznany format odpowiedzi: ${results.verification_type}</div>`;
        detailsText = JSON.stringify(results, null, 2);
    }
    
    return { summaryHtml, detailsText };
  }

  async function verifyScene(){
    if(editPoly) toggleEdit();
    const rois = roisOut();
    if(!rois.length) return notyf.error('Dodaj ROI przed weryfikacjƒÖ');

    if (!canvas.backgroundImage) {
        return notyf.error('Za≈Çaduj obraz t≈Ça, aby uruchomiƒá weryfikacjƒô NCSim.');
    }
    const imageBase64 = canvas.toDataURL();

    const deployment = {
         serialNumber: $('serial-number').value || '',
         locationId: $('location-id').value || '',
         gpsLat: $('gps-lat').value || '',
         gpsLon: $('gps-lon').value || '',
         backendAddr: $('backend-addr').value || '',
         swdallowMasks: $('swdallow-masks').value || '',
         nativeallowMasks: $('nativeallow-masks').value || ''
       };

    const terminalIp = $('device-ip').value;
    if(!terminalIp) return notyf.error('Podaj IP terminala');
    if(!deployment.locationId) return notyf.error('Wymagane ID lokalizacji');

    console.log('üîç Debug - Dane do weryfikacji:');
    console.log('ROI count:', rois.length);
    console.log('ROI data:', rois);
    console.log('Deployment:', deployment);
    console.log('Terminal IP:', terminalIp);
    console.log('Image base64 length:', imageBase64.length);

    const requestData = {
        package: { rois, deployment },
        password: $('device-pass').value || '',
        terminal_ip: terminalIp,
        image_base64: imageBase64
    };

    $('panel-verify').style.display='block';
    $('verify-summary').innerHTML = '<div class="result-info">üî¨ Uruchamiam weryfikacjƒô ROI z NCSim (opcjonalna weryfikacja)...</div>';
    $('verify-out').textContent = '≈ÅƒÖczenie z terminalem, przygotowywanie konfiguracji i obrazu...';

    showLoader();
    try{
      const res = await fetch('/verify-scene/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
      });

      const data = await res.json();

      if (!res.ok) {
        console.error('‚ùå B≈ÇƒÖd serwera:', data);
        throw new Error(data.detail || 'Nieznany b≈ÇƒÖd serwera');
      }

      if (data.success && data.parsed_recognition_data) {
        const { summaryHtml, detailsText } = formatVerificationResults(data.parsed_recognition_data);
        $('verify-summary').innerHTML = summaryHtml;
        $('verify-out').textContent = detailsText;
        notyf.success('Weryfikacja zako≈Ñczona');
      } else {
        $('verify-summary').innerHTML = '<div class="result-error">‚ùå B≈ÇƒÖd przetwarzania wynik√≥w</div>';
        $('verify-out').textContent = `B≈ÇƒÖd: ${data.error || 'Brak danych'}`;
        notyf.error('B≈ÇƒÖd podczas weryfikacji');
      }

    }catch(e){
      console.error('‚ùå B≈ÇƒÖd w verifyScene:', e);
      $('verify-summary').innerHTML = `<div class="result-error">‚ùå B≈ÇƒÖd krytyczny: ${e.message}</div>`;
      $('verify-out').textContent = 'Sprawd≈∫ konsolƒô przeglƒÖdarki i logi serwera FastAPI, aby uzyskaƒá wiƒôcej informacji.';
      notyf.error('Weryfikacja nieudana: ' + e.message, {duration: 6000});
    }finally{
      hideLoader();
    }
  }

  async function runNcshot(){
    if(editPoly) toggleEdit();
    const rois = roisOut();
    if(!rois.length) return notyf.error('Dodaj ROI przed uruchomieniem NCShot');

    const deployment = {
         serialNumber: $('serial-number').value || '',
         locationId: $('location-id').value || '',
         gpsLat: $('gps-lat').value || '',
         gpsLon: $('gps-lon').value || '',
         backendAddr: $('backend-addr').value || '',
         swdallowMasks: $('swdallow-masks').value || '',
         nativeallowMasks: $('nativeallow-masks').value || ''
       };

    if(!deployment.locationId) return notyf.error('Wymagane ID lokalizacji');

    // Przygotuj obrazy z galerii - u≈ºywaj bezpo≈õrednio src (ju≈º sƒÖ skonwertowane przez serwer)
    const galleryImages = [];
    const galleryImgs = $('gallery').querySelectorAll('img');

    if(galleryImgs.length === 0) {
      return notyf.error('Najpierw pobierz obrazy z terminala');
    }

    // U≈ºyj obraz√≥w ju≈º przygotowanych przez serwer (ju≈º sƒÖ w JPEG base64)
    for(let img of galleryImgs) {
      try {
        galleryImages.push(img.src); // src ju≈º zawiera data:image/jpeg;base64,
      } catch(e) {
        console.error('B≈ÇƒÖd przygotowania obrazu:', e);
      }
    }

    if(galleryImages.length === 0) {
      return notyf.error('Nie mo≈ºna przygotowaƒá obraz√≥w do przetworzenia');
    }

    console.log('üîß Debug - NCShot z konwersjƒÖ obraz√≥w:');
    console.log('ROI count:', rois.length);
    console.log('Images count:', galleryImages.length);
    console.log('Deployment:', deployment);

    const requestData = {
        package: { rois, deployment },
        image_files: galleryImages
    };

    $('panel-verify').style.display='block';
    $('verify-summary').innerHTML = '<div class="result-info">üöÄ NCShot z automatycznƒÖ konwersjƒÖ .bif/.zur ‚Üí .jpg na serwerze...</div>';
    $('verify-out').textContent = `Przetwarzanie ${galleryImages.length} obraz√≥w (automatycznie skonwertowanych na JPEG)...`;

    showLoader();
    try{
      const res = await fetch('/ncshot/', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
      });

      const data = await res.json();

      if (!res.ok) {
        console.error('‚ùå B≈ÇƒÖd serwera NCShot:', data);
        throw new Error(data.detail || 'Nieznany b≈ÇƒÖd serwera');
      }

      if (data.success && data.results) {
        let summaryHtml = '<div class="result-summary"><strong>üöÄ WYNIKI NCSHOT z KONWERSJƒÑ OBRAZ√ìW</strong><br>';
        let detailsText = '=== WYNIKI NCSHOT (z automatycznƒÖ konwersjƒÖ .bif/.zur) ===\n\n';

        const resultCount = Object.keys(data.results).length;
        summaryHtml += `<span class="status-ok">‚úÖ Przetworzonych obraz√≥w: <strong>${resultCount}</strong></span><br>`;
        summaryHtml += `<span class="status-ok">üîÑ Obrazy automatycznie skonwertowane na JPEG dla NCShot</span><br></div>`;

        for(const [imageKey, result] of Object.entries(data.results)) {
          detailsText += `--- ${imageKey} ---\n`;
          detailsText += `XML: ${result.xml ? 'TAK' : 'NIE'}\n`;
          detailsText += `P≈Çytki: ${result.plates ? result.plates.length : 0}\n\n`;

          // Dodaj obrazy p≈Çytek do galerii
          if(result.plates && result.plates.length > 0) {
            for(let i = 0; i < result.plates.length; i++) {
              if(result.plates[i]) {
                const plateContainer = document.createElement('div');
                plateContainer.className = 'image-container';
                
                const plateImg = document.createElement('img');
                plateImg.src = result.plates[i];
                plateImg.style.border = '2px solid blue';
                plateImg.className = 'plate-result';
                plateImg.title = `P≈Çytka ${i+1} z ${imageKey} - rozpoznana przez NCShot`;
                
                const plateLabel = document.createElement('div');
                plateLabel.className = 'format-label';
                plateLabel.textContent = 'P≈ÅYTKA';
                plateLabel.style.backgroundColor = 'rgba(0,0,255,0.8)';
                
                plateContainer.appendChild(plateImg);
                plateContainer.appendChild(plateLabel);
                $('gallery').appendChild(plateContainer);
              }
            }
          }
        }

        $('verify-summary').innerHTML = summaryHtml;
        $('verify-out').textContent = detailsText;
        notyf.success('üöÄ NCShot zako≈Ñczony - obrazy automatycznie skonwertowane na JPEG');
      } else {
        $('verify-summary').innerHTML = '<div class="result-error">‚ùå B≈ÇƒÖd przetwarzania wynik√≥w</div>';
        $('verify-out').textContent = `B≈ÇƒÖd: ${data.error || 'Brak danych'}`;
        notyf.error('B≈ÇƒÖd podczas uruchamiania NCShot');
      }

    }catch(e){
      console.error('‚ùå B≈ÇƒÖd w runNcshot:', e);
      $('verify-summary').innerHTML = `<div class="result-error">‚ùå B≈ÇƒÖd krytyczny: ${e.message}</div>`;
      $('verify-out').textContent = 'Sprawd≈∫ konsolƒô przeglƒÖdarki i logi serwera FastAPI, aby uzyskaƒá wiƒôcej informacji.';
      notyf.error('NCShot nieudany: ' + e.message, {duration: 6000});
    }finally{
      hideLoader();
    }
  }

  async function debugNcshot(){
    console.log('üõ† === DEBUG NCSHOT z KONWERSJƒÑ ===');
    
    const rois = roisOut();
    console.log('üéØ ROI Data:', rois);
    
    const deployment = {
      serialNumber: $('serial-number').value || '',
      locationId: $('location-id').value || '',
      gpsLat: $('gps-lat').value || '',
      gpsLon: $('gps-lon').value || '',
      backendAddr: $('backend-addr').value || '',
      swdallowMasks: $('swdallow-masks').value || '',
      nativeallowMasks: $('nativeallow-masks').value || ''
    };
    console.log('‚öôÔ∏è Deployment Config:', deployment);
    
    const galleryImgs = $('gallery').querySelectorAll('img');
    console.log('üñºÔ∏è Gallery Images:', galleryImgs.length);
    
    // Sprawd≈∫ informacje o obrazach
    const imageInfo = [];
    galleryImgs.forEach((img, i) => {
      const formatLabel = img.parentElement.querySelector('.format-label');
      const format = formatLabel ? formatLabel.textContent : 'UNKNOWN';
      imageInfo.push({
        index: i,
        format: format,
        src_length: img.src.length,
        is_base64: img.src.startsWith('data:image')
      });
    });
    console.log('üìä Informacje o obrazach:', imageInfo);
    
    const debugInfo = `
=== DEBUG INFO NCSHOT z KONWERSJƒÑ ===

ROI Count: ${rois.length}
Location ID: ${deployment.locationId || 'BRAK!'}
Images Count: ${galleryImgs.length}

Obrazy w galerii:
${imageInfo.map(info => `
  Obraz ${info.index + 1}:
  - Format: ${info.format}
  - Base64: ${info.is_base64 ? 'TAK' : 'NIE'}
  - Rozmiar src: ${info.src_length} znak√≥w
`).join('\n')}

ROI Details:
${rois.map((roi, i) => `
  ROI ${i+1} (${roi.id}):
  - Points: ${roi.points?.length || 0}
  - Angle: ${roi.angle}
  - Zoom: ${roi.zoom}
  - Offset H/V: ${roi.reflexOffsetH}/${roi.reflexOffsetV}
  - Skew H/V: ${roi.skewH}/${roi.skewV}
`).join('\n')}

Terminal: ${$('device-ip').value || 'BRAK IP!'}

=== SPRAWD≈π ===
1. Czy masz obrazy w galerii?
2. Czy ustawiono Location ID?
3. Czy ROI majƒÖ prawid≈Çowe parametry?
4. Czy IP terminala jest ustawione?
5. Czy obrazy zosta≈Çy skonwertowane na JPEG?

=== KONWERSJA OBRAZ√ìW ===
Serwer automatycznie konwertuje .bif/.zur ‚Üí .jpg
Sprawd≈∫ logi serwera dla szczeg√≥≈Ç√≥w konwersji
`;

    $('panel-verify').style.display='block';
    $('verify-summary').innerHTML = '<div class="debug-info"><strong>üõ† DEBUG NCSHOT z KONWERSJƒÑ</strong><br>Informacje diagnostyczne wy≈õwietlone w konsoli i poni≈ºej.</div>';
    $('verify-out').textContent = debugInfo;
    
    console.log(debugInfo);
    notyf.success('Debug info wy≈õwietlony w konsoli i panelu');
  }
</script>
</body>
</html>
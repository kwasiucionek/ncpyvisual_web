<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>NCPyVisual - Wersja Webowa (NCSim + NCShot przez SSH)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
  <style>
    html, body { height:100%; margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background:#f0f2f5; overflow:hidden; }
    .app { display:flex; flex-direction:column; height:100%; }
    .app__header { height:56px; background:#fff; border-bottom:1px solid #d9d9d9; display:flex; align-items:center; padding:0 16px; }
    .app__header h1 { font-size:1.25rem; margin:0; }
    .side { width:340px; background:#fafafa; border-right:1px solid #d9d9d9; padding:16px; overflow:auto; }
    .side h3 { margin:16px 0 8px; }
    .block { background:#fff; border:1px solid #e3e3e3; border-radius:8px; padding:12px; margin-bottom:12px; }
    .form-row { margin-bottom:10px; }
    .form-row label { display:block; font-weight:600; margin-bottom:4px; }
    .form-row input[type="text"], .form-row input[type="password"], .form-row input[type="number"] { width:100%; padding:8px; border:1px solid #ccc; border-radius:6px; box-sizing: border-box; }
    .btn { width:100%; padding:10px; border:0; border-radius:8px; cursor:pointer; margin-top:6px; font-size:0.95rem; }
    .btn--primary { background:#007bff; color:#fff; }
    .btn--success { background:#28a745; color:#fff; }
    .btn--warn { background:#ffc107; color:#000; }
    .btn--danger { background:#dc3545; color:#fff; }
    .btn--muted { background:#6c757d; color:#fff; }
    .btn--purple { background:#6f42c1; color:#fff; }
    .content { flex:1; display:flex; align-items:center; justify-content:center; padding:16px; overflow:auto; background:#e9e9e9; }
    .app__main { display:flex; flex:1; min-height:0; }
    #image-canvas { background:#fff; box-shadow:0 4px 8px rgba(0,0,0,.08); }
    #loader { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,.7); z-index:999; }
    .spinner { width:56px; height:56px; border-radius:50%; border:8px solid #eee; border-top-color:#3498db; animation:spin 1s linear infinite; }
    @keyframes spin{to{transform:rotate(360deg)}}
    .gallery { max-height:220px; overflow:auto; border:1px solid #ddd; background:#fff; border-radius:6px; padding:6px; }
    .gallery img { width:100%; max-width:260px; margin:6px auto; display:block; cursor:pointer; border:2px solid transparent; border-radius:4px; }
    .gallery img:hover{ border-color:#3498db; }
    input[type="file"]{ display:none; }
    .filelike { display:inline-block; width:100%; text-align:center; padding:10px; border:1px solid #ccc; border-radius:8px; cursor:pointer; background:#f9f9f9; box-sizing: border-box; }
    .panel-title { margin-top:14px; border-top:2px solid #ddd; padding-top:10px; font-size:1.05rem; }
    pre { white-space:pre-wrap; word-wrap:break-word; background:#fff; border:1px solid #eee; border-radius:8px; padding:10px; max-height: 400px; overflow-y: auto; font-size:0.85rem; }
    .result-summary { background:#e8f5e8; border:1px solid #4caf50; border-radius:6px; padding:8px; margin:8px 0; }
    .result-error { background:#ffe8e8; border:1px solid #f44336; border-radius:6px; padding:8px; margin:8px 0; }
    .plate-result { background:#e3f2fd; border-left:4px solid #2196f3; padding:8px; margin:4px 0; border-radius:4px; }
    .vehicle-result { background:#f3e5f5; border-left:4px solid #9c27b0; padding:8px; margin:4px 0; border-radius:4px; }
    .ncshot-result { background:#fff3e0; border-left:4px solid #ff9800; padding:8px; margin:4px 0; border-radius:4px; }
    .verification-tabs { display:flex; gap:4px; margin-bottom:8px; }
    .tab-btn { flex:1; padding:8px; border:1px solid #ccc; background:#f5f5f5; cursor:pointer; text-align:center; border-radius:4px; font-size:0.9rem; }
    .tab-btn.active { background:#007bff; color:#fff; border-color:#007bff; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    .btn-group { display:flex; gap:4px; }
    .btn-group .btn { margin-top:0; flex:1; }
    .plate-image { max-width:100%; height:auto; border:1px solid #ddd; border-radius:4px; margin-top:6px; }
    .tunnel-info { background:#e1f5fe; border:1px solid #01579b; border-radius:4px; padding:6px; margin:4px 0; font-size:0.85rem; }
    .method-badge { display:inline-block; background:#17a2b8; color:#fff; padding:2px 6px; border-radius:3px; font-size:0.8rem; margin-left:4px; }
    .ssh-warning { background:#fff3cd; border:1px solid #856404; color:#856404; border-radius:4px; padding:8px; margin:8px 0; font-size:0.9rem; }
  </style>
</head>
<body>
<div id="loader"><div class="spinner"></div></div>
<div class="app">
  <header class="app__header"><h1>NCPyVisual üîó (NCSim + NCShot przez SSH)</h1></header>
  <main class="app__main">
    <aside class="side">

      <div class="block">
        <h3>1) Terminal docelowy</h3>
        <div class="ssh-warning">
          ‚ö†Ô∏è <strong>Oba narzƒôdzia</strong> (NCSim i NCShot) wymagajƒÖ dostƒôpu SSH do terminala przez jump host
        </div>
        <div class="form-row">
          <label for="device-ip">Adres IP terminala</label>
          <input id="device-ip" type="text" placeholder="np. 172.16.3.13">
        </div>
        <div class="form-row">
          <label for="device-pass">Has≈Ço (root)</label>
          <input id="device-pass" type="password" placeholder="has≈Ço SSH">
        </div>
        <button id="btn-import" class="btn btn--primary">Pobierz konfiguracjƒô</button>
      </div>

      <div class="block">
        <h3>2) Najnowsze zdjƒôcia</h3>
        <div class="form-row">
          <label for="image-count">Ilo≈õƒá</label>
          <input id="image-count" type="number" min="1" max="100" value="10">
        </div>
        <button id="btn-fetch" class="btn btn--primary">Pobierz i wy≈õwietl</button>
        <div id="gallery" class="gallery"></div>
      </div>

      <div class="block">
        <h3>Obraz & ROI</h3>
        <label for="image-input" class="filelike">Wczytaj obraz (.jpg/.png)</label>
        <input id="image-input" type="file" accept=".jpg,.jpeg,.png">
        <label for="xml-input" class="filelike" style="margin-top:6px;">Wczytaj ROI z XML</label>
        <input id="xml-input" type="file" accept=".xml">
        <button id="btn-draw" class="btn">Rysuj ROI</button>
        <button id="btn-clear" class="btn btn--muted">Wyczy≈õƒá ROI</button>
      </div>

      <div class="block">
        <h3>3) Konfiguracja / eksport</h3>
        <div class="form-row"><label for="serial-number">Numer seryjny</label><input id="serial-number" type="text" placeholder="np. 593-072-73194"></div>
        <div class="form-row"><label for="location-id">ID Lokalizacji</label><input id="location-id" type="text" placeholder="np. WSC.3.069"></div>
        <div class="form-row"><label for="gps-lat">Szer. geogr.</label><input id="gps-lat" type="text" placeholder="51.2533333"></div>
        <div class="form-row"><label for="gps-lon">D≈Ç. geogr.</label><input id="gps-lon" type="text" placeholder="22.5478611"></div>
        <div class="panel-title">Zaawansowane</div>
        <div class="form-row"><label for="backend-addr">Adres fotoradaru</label><input id="backend-addr" type="text" placeholder="np. 172.20.2.23"></div>
        <div class="form-row"><label for="swdallow-masks">SWD Allow</label><input id="swdallow-masks" type="text" placeholder="172.16.0.0/24 ..."></div>
        <div class="form-row"><label for="nativeallow-masks">Native Allow</label><input id="nativeallow-masks" type="text" placeholder="0.0.0.0/0"></div>
        <button id="btn-package" class="btn btn--success">Generuj pakiet</button>
      </div>

      <div id="panel-props" class="block" style="display:none;">
        <h3>W≈Ça≈õciwo≈õci ROI</h3>
        <div class="form-row"><label for="roi-id">ID</label><input id="roi-id" type="text" readonly></div>
        <div class="form-row"><label>KƒÖt</label><input class="param-input" data-param="angle" id="param-angle" type="number" step="0.1"></div>
        <div class="form-row"><label>Zoom</label><input class="param-input" data-param="zoom" id="param-zoom" type="number" step="0.01"></div>
        <div class="form-row"><label>Offset H</label><input class="param-input" data-param="reflexOffsetH" id="param-oh" type="number"></div>
        <div class="form-row"><label>Offset V</label><input class="param-input" data-param="reflexOffsetV" id="param-ov" type="number"></div>
        <div class="form-row"><label>Skew H</label><input class="param-input" data-param="skewH" id="param-sh" type="number" step="0.01"></div>
        <div class="form-row"><label>Skew V</label><input class="param-input" data-param="skewV" id="param-sv" type="number" step="0.01"></div>
        <button id="btn-edit" class="btn btn--warn">Edytuj kszta≈Çt</button>
        
        <div class="panel-title">Weryfikacja ROI</div>
        <div class="btn-group">
          <button id="btn-verify" class="btn btn--primary">üî¨ NCSim</button>
          <button id="btn-verify-ncshot" class="btn btn--purple">üéØ NCShot</button>
        </div>
        <div style="font-size:0.8rem; color:#666; margin-top:4px; text-align:center;">
          NCSim: symulacja | NCShot: pe≈Çna analiza
        </div>
        <button id="btn-del" class="btn btn--danger" style="margin-top:6px;">Usu≈Ñ ROI</button>
      </div>

      <div id="panel-verify" class="block" style="display:none;">
        <h3>Wyniki weryfikacji</h3>
        <div class="verification-tabs">
          <div class="tab-btn active" data-tab="summary">Podsumowanie</div>
          <div class="tab-btn" data-tab="details">Szczeg√≥≈Çy</div>
          <div class="tab-btn" data-tab="raw">Raw Data</div>
        </div>
        
        <div class="tab-content active" id="tab-summary">
          <div id="verify-summary"></div>
          <div id="verify-tunnel-info"></div>
          <div id="verify-plates"></div>
          <div id="verify-vehicles"></div>
        </div>
        
        <div class="tab-content" id="tab-details">
          <pre id="verify-details"></pre>
        </div>
        
        <div class="tab-content" id="tab-raw">
          <pre id="verify-raw"></pre>
        </div>
      </div>

    </aside>
    <section class="content">
      <canvas id="image-canvas"></canvas>
    </section>
  </main>
</div>

<script>
  const notyf = new Notyf({ duration: 4000, position: { x:'right', y:'top' }});
  let canvas, drawing=false, editPoly=null, tmpPts=[], tmpDots=[], roiCount=0, storedRois = [];

  const roiColors = [
    { fill:'rgba(0,255,0,.3)', stroke:'green' },
    { fill:'rgba(255,255,0,.3)', stroke:'orange' },
    { fill:'rgba(255,0,255,.3)', stroke:'magenta' },
    { fill:'rgba(0,255,255,.3)', stroke:'cyan' },
    { fill:'rgba(255,165,0,.3)', stroke:'darkorange' },
  ];

  const $ = (id)=>document.getElementById(id);
  const $loader = $('loader');
  const showLoader = ()=> $loader.style.display='flex';
  const hideLoader = ()=> $loader.style.display='none';

  document.addEventListener('DOMContentLoaded', ()=>{
    canvas = new fabric.Canvas('image-canvas');
    bindUI();
    initTabs();
  });

  function initTabs(){
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const targetTab = e.target.getAttribute('data-tab');
        // Remove active from all tabs and contents
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        // Add active to clicked tab and corresponding content
        e.target.classList.add('active');
        document.getElementById(`tab-${targetTab}`).classList.add('active');
      });
    });
  }

  function bindUI(){
    $('btn-import').onclick = importFromDevice;
    $('btn-fetch').onclick = fetchImages;
    $('btn-package').onclick = generatePackage;
    $('btn-draw').onclick = startDraw;
    $('btn-clear').onclick = clearRoi;
    $('btn-edit').onclick = toggleEdit;
    $('btn-del').onclick = ()=> deleteRoi(true);
    $('btn-verify').onclick = verifyScene;
    $('btn-verify-ncshot').onclick = verifySceneNcshot;

    $('image-input').onchange = loadImage;
    $('xml-input').onchange = loadXml;

    canvas.on('mouse:down', onMouseDown);
    canvas.on('selection:created', onSelect);
    canvas.on('selection:updated', onSelect);
    canvas.on('selection:cleared', onClearSel);

    document.querySelectorAll('.param-input').forEach(inp=>{
      inp.addEventListener('input', onParamChange);
    });

    document.addEventListener('keydown', (e)=>{
      if(document.activeElement.tagName==='INPUT') return;
      if(e.key==='Delete' || e.key==='Backspace') deleteRoi(false);
    });

    const cc = document.querySelector('.canvas-container');
    if(cc) cc.addEventListener('contextmenu', (e)=>{ e.preventDefault(); if(drawing) finishPolygon(); });
  }

  function loadImage(ev){
    const f = ev.target.files[0]; if(!f) return;
    const url = URL.createObjectURL(f);

    fabric.Image.fromURL(url, (img) => {
        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {});
        canvas.setWidth(img.width);
        canvas.setHeight(img.height);
        canvas.renderAll();
        URL.revokeObjectURL(url);

        // Rysuj zapisane ROI po za≈Çadowaniu obrazu
        if (storedRois.length > 0) {
            drawRois(storedRois);
            storedRois = []; 
            notyf.info('Narysowano wcze≈õniej zaimportowane ROI.');
        }
    });
  }

  function startDraw(){
    if(editPoly) toggleEdit();
    drawing = true; canvas.selection = false;
    $('btn-draw').disabled = true; $('btn-draw').textContent = 'Rysowanie‚Ä¶ (PPM ko≈Ñczy)';
  }

  function onMouseDown(opt){
    if(!drawing) return;
    if(opt.e.button !== 0) return;
    const p = canvas.getPointer(opt.e);

    if (!canvas.backgroundImage) {
        notyf.error("Najpierw za≈Çaduj obraz t≈Ça.");
        resetDraw();
        return;
    }

    tmpPts.push({x: p.x, y: p.y});
    const dot = new fabric.Circle({ left:p.x, top:p.y, radius:3, fill:'red', selectable:false, originX:'center', originY:'center' });
    canvas.add(dot); tmpDots.push(dot); canvas.renderAll();
  }

  function finishPolygon(){
    if(tmpPts.length < 3){ resetDraw(); return; }
    const color = roiColors[roiCount % roiColors.length]; roiCount++;
    const bg = canvas.backgroundImage;
    if (!bg) { resetDraw(); return; }

    const relativePoints = tmpPts.map(p => ({ x: p.x / bg.width, y: p.y / bg.height }));

    const poly = new fabric.Polygon(tmpPts, {
      fill: color.fill, stroke: color.stroke, strokeWidth:2, selectable:true, hasControls:true,
      customData: { id:`ROI-${roiCount}`, angle:0, zoom:1, reflexOffsetH:0, reflexOffsetV:0, skewH:0, skewV:0, points: relativePoints }
    });
    canvas.add(poly); resetDraw();
  }

  function resetDraw(){
    tmpDots.forEach(d=>canvas.remove(d)); tmpDots=[]; tmpPts=[]; drawing=false; canvas.selection = true;
    $('btn-draw').disabled=false; $('btn-draw').textContent='Rysuj ROI'; canvas.renderAll();
  }

  function onSelect(e){
    if(editPoly) toggleEdit();
    const o = e.selected[0];
    if(o && o.customData){
      $('panel-props').style.display='block';
      $('roi-id').value = o.customData.id || '';
      document.querySelectorAll('.param-input').forEach(inp=>{
        const k = inp.dataset.param; inp.value = o.customData[k] ?? 0;
      });
    } else $('panel-props').style.display='none';
  }
  function onClearSel(){ if(editPoly) toggleEdit(); $('panel-props').style.display='none'; }
  function onParamChange(e){
    const o = canvas.getActiveObject(); if(!(o&&o.customData)) return;
    const k = e.target.dataset.param; o.customData[k] = parseFloat(e.target.value) || 0;
  }

  function deleteRoi(confirmFirst){
    const o = canvas.getActiveObject(); if(!o){ if(confirmFirst) notyf.error('Nie zaznaczono ROI'); return; }
    if(confirmFirst && !confirm(`UsunƒÖƒá ${o.customData.id}?`)) return;
    canvas.remove(o); notyf.success('Usuniƒôto ROI'); canvas.renderAll();
  }

  function toggleEdit(){
    const btn = $('btn-edit');
    if(editPoly){
      editPoly.edit = false;
      const bg = canvas.backgroundImage;
      if (bg && editPoly.points) {
        const matrix = editPoly.calcTransformMatrix();
        editPoly.customData.points = editPoly.points.map(p => {
            const transformedPoint = fabric.util.transformPoint({x: p.x, y: p.y}, matrix);
            return { x: transformedPoint.x / bg.width, y: transformedPoint.y / bg.height };
        });
      }
      canvas.setActiveObject(editPoly);
      btn.textContent='Edytuj kszta≈Çt'; btn.className='btn btn--warn';
      editPoly = null; canvas.renderAll();
    } else {
      const o = canvas.getActiveObject();
      if(!(o && o.type==='polygon')){ notyf.error('Zaznacz poligon'); return; }
      editPoly = o; editPoly.edit = true; btn.textContent='Zatwierd≈∫'; btn.className='btn btn--primary';
      canvas.setActiveObject(editPoly); canvas.renderAll();
    }
  }

  function clearRoi(){
    if(!confirm('Wyczy≈õciƒá wszystkie ROI?')) return;
    canvas.getObjects().filter(o=>o.customData).forEach(o=>canvas.remove(o)); roiCount=0; canvas.renderAll(); notyf.success('Wyczyszczono ROI');
  }

  function roisOut(){
      return canvas.getObjects().filter(o => o.customData).map(o => {
          const bg = canvas.backgroundImage;
          if (bg && o.points && o.dirty) { 
                const matrix = o.calcTransformMatrix();
                const updatedPoints = o.points.map(p => {
                    const transformedPoint = fabric.util.transformPoint({x: p.x, y: p.y}, matrix);
                    return { x: transformedPoint.x / bg.width, y: transformedPoint.y / bg.height };
                });
                return { ...o.customData, points: updatedPoints };
          }
          return o.customData;
      });
  }

  async function importFromDevice(){
    const ip=$('device-ip').value, password=$('device-pass').value;
    if(!ip) return notyf.error('Podaj IP terminala');
    showLoader();
    try{
      const res = await fetch('/import-from-device/', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ ip, password })});
      if(!res.ok){ const e=await res.json(); throw new Error(e.detail || 'B≈ÇƒÖd importu'); }
      const data = await res.json();

      $('serial-number').value = data.serialNumber || '';
      $('location-id').value = data.locationId || '';
      $('gps-lat').value = data.gpsLat || '';
      $('gps-lon').value = data.gpsLon || '';
      $('backend-addr').value = data.backendAddr || '';
      $('swdallow-masks').value = data.swdallowMasks || '';
      $('nativeallow-masks').value = data.nativeallowMasks || '';

      if(data.rois && data.rois.length){
          storedRois = data.rois;
          notyf.success(`Zaimportowano konfiguracjƒô i ${data.rois.length} ROI. ZostanƒÖ narysowane po wczytaniu obrazu.`);
      }
      else {
          storedRois = [];
          canvas.getObjects().filter(o=>o.customData).forEach(o=>canvas.remove(o));
          canvas.renderAll();
          notyf.success('Zaimportowano konfiguracjƒô. Brak ROI na urzƒÖdzeniu.');
      }
    }catch(e){ notyf.error(e.message); } finally{ hideLoader(); }
  }

  function drawRois(list){
    canvas.getObjects().filter(o=>o.customData).forEach(o=>canvas.remove(o));
    const bg = canvas.backgroundImage;
    if (!bg) {
        storedRois = list;
        notyf.error("B≈ÇƒÖd: brak t≈Ça. ROI zostanƒÖ narysowane po wczytaniu obrazu.");
        return;
    }

    list.forEach((r,i)=>{
      const color = roiColors[i % roiColors.length];
      const absolutePoints = (r.points && r.points.length)
        ? r.points.map(p => ({ x: p.x * bg.width, y: p.y * bg.height }))
        : [{x:40+i*10,y:40+i*10},{x:160+i*10,y:40+i*10},{x:160+i*10,y:160+i*10},{x:40+i*10,y:160+i*10}];

      const cd = {...r};
      const poly = new fabric.Polygon(absolutePoints, { fill:color.fill, stroke:color.stroke, strokeWidth:2, selectable:true, hasControls:true, customData:cd, objectCaching: false });
      canvas.add(poly);
    });
    roiCount = list.length; canvas.renderAll();
  }

  async function fetchImages(){
    const ip=$('device-ip').value, password=$('device-pass').value, count=parseInt($('image-count').value||'10',10);
    if(!ip) return notyf.error('Podaj IP terminala');
    $('gallery').innerHTML='';
    showLoader();
    try{
      const res = await fetch('/fetch-device-images/', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ ip, password, count })});
      if(!res.ok){ const e=await res.json(); throw new Error(e.detail || 'B≈ÇƒÖd'); }
      const data = await res.json();
      if(data.images && data.images.length){
        notyf.success(`Pobrano ${data.images.length} zdjƒôƒá`);
        data.images.forEach(it=>{
          const img=document.createElement('img'); img.src=it.data; img.title=it.filename;
          img.onclick = ()=>{
            fabric.Image.fromURL(img.src, (fabricImg) => {
                canvas.setBackgroundImage(fabricImg, canvas.renderAll.bind(canvas));
                canvas.setWidth(fabricImg.width);
                canvas.setHeight(fabricImg.height);
                notyf.success('Za≈Çadowano t≈Ço');

                if (storedRois.length > 0) {
                    drawRois(storedRois);
                    storedRois = []; 
                    notyf.info('Narysowano wcze≈õniej zaimportowane ROI.');
                }
            });
          };
          $('gallery').appendChild(img);
        });
      } else notyf.success('Brak zdjƒôƒá na urzƒÖdzeniu.');
    }catch(e){ notyf.error(e.message); } finally{ hideLoader(); }
  }

  async function loadXml(ev){
    const f = ev.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = async (e)=>{
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(e.target.result, "text/xml");
        const roisFromXml = [];
        const roiNodes = xmlDoc.getElementsByTagName("roi");
        if (!canvas.backgroundImage && roiNodes.length > 0) {
            notyf.error("Proszƒô najpierw za≈Çadowaƒá obraz t≈Ça przed importem ROI z XML.");
            return;
        }

        for (let i = 0; i < roiNodes.length; i++) {
            const node = roiNodes[i];
            const pointsStr = node.getElementsByTagName("points")[0]?.textContent || '';
            const points = pointsStr.split(';').filter(p=>p).map(p => ({ x: parseFloat(p.split(',')[0]), y: parseFloat(p.split(',')[1]) }));
            roisFromXml.push({
                id: node.getAttribute("id"),
                points: points,
                angle: parseFloat(node.getElementsByTagName("angle")[0]?.textContent || 0),
                zoom: parseFloat(node.getElementsByTagName("zoom")[0]?.textContent || 1),
                reflexOffsetH: parseInt(node.getElementsByTagName("reflexOffsetH")[0]?.textContent || 0, 10),
                reflexOffsetV: parseInt(node.getElementsByTagName("reflexOffsetV")[0]?.textContent || 0, 10),
                skewH: parseFloat(node.getElementsByTagName("skewH")[0]?.textContent || 0),
                skewV: parseFloat(node.getElementsByTagName("skewV")[0]?.textContent || 0),
            });
        }
        if(roisFromXml.length > 0){
            drawRois(roisFromXml);
            notyf.success(`Wczytano ${roisFromXml.length} ROI z pliku XML.`);
        } else {
            notyf.error('Nie znaleziono ROI w pliku XML.');
        }
    };
    reader.readAsText(f);
  }

  function formatVerificationResults(results) {
    let summaryHtml = '';
    let detailsText = '';
    let rawData = '';
    let platesHtml = '';
    let vehiclesHtml = '';
    let tunnelInfoHtml = '';

    if (results.verification_type === 'ncsim_verification') {
      const sim_results = results.results;
      summaryHtml = `
        <div class="result-summary">
          <strong>üî¨ SYMULACJA NCSIM</strong><span class="method-badge">SSH Exec</span><br>
          ‚úÖ Rozpoznanie Silne: <strong>${sim_results.recog_strong !== null ? sim_results.recog_strong.toFixed(2) + '%' : 'N/A'}</strong><br>
          ‚òëÔ∏è Rozpoznanie S≈Çabe: <strong>${sim_results.recog_weak !== null ? sim_results.recog_weak.toFixed(2) + '%' : 'N/A'}</strong><br>
          ‚öôÔ∏è Metoda: ${results.processing_method}<br>
          ‚è±Ô∏è Czas: ${sim_results.processing_time || 'N/A'}
        </div>`;

      detailsText = `=== WYNIKI SYMULACJI NCSIM ===\n\n`;
      detailsText += `Status: ${sim_results.processing_successful ? 'SUKCES' : 'B≈ÅƒÑD'}\n`;
      detailsText += `Rozpoznanie silne: ${sim_results.recog_strong || 'N/A'}%\n`;
      detailsText += `Rozpoznanie s≈Çabe: ${sim_results.recog_weak || 'N/A'}%\n`;
      detailsText += `Czas przetwarzania: ${sim_results.processing_time || 'N/A'}\n\n`;

      rawData = sim_results.ncsim_output || 'Brak danych wyj≈õciowych z ncsim.';

    } else if (results.verification_type === 'ncshot_verification') {
      const shot_results = results.results;
      
      summaryHtml = `
        <div class="result-summary">
          <strong>üéØ ANALIZA NCSHOT</strong><span class="method-badge">SSH Tunnel</span><br>
          üìã Tablice wykryte: <strong>${shot_results.summary?.plates_detected || 0}</strong><br>
          üöó Pojazdy wykryte: <strong>${shot_results.summary?.vehicles_detected || 0}</strong><br>
          ‚úÖ Najwy≈ºsza pewno≈õƒá tablicy: <strong>${(shot_results.summary?.best_plate_confidence * 100 || 0).toFixed(1)}%</strong><br>
          üöô Najwy≈ºsza pewno≈õƒá pojazdu: <strong>${(shot_results.summary?.best_vehicle_confidence * 100 || 0).toFixed(1)}%</strong><br>
          üîó Token: ${results.token_used || 'N/A'}
        </div>`;

      // Informacje o tunelu SSH
      if (results.tunnel_info) {
        tunnelInfoHtml = `
          <div class="tunnel-info">
            üîÄ <strong>SSH Tunnel:</strong> ${results.tunnel_info} ‚Üí terminal:5543<br>
            üì° Metoda: ${results.processing_method}
          </div>`;
      }

      // Tablice
      if (shot_results.plates && shot_results.plates.length > 0) {
        platesHtml = '<h4>üìã Wykryte tablice:</h4>';
        shot_results.plates.forEach((plate, i) => {
          platesHtml += `
            <div class="plate-result">
              <strong>Tablica ${i+1}:</strong> ${plate.text || 'N/A'}<br>
              <strong>Kraj:</strong> ${plate.country || 'N/A'} | 
              <strong>Pewno≈õƒá:</strong> ${(plate.confidence * 100).toFixed(1)}% | 
              <strong>Typ:</strong> ${plate.type || 'N/A'}<br>
              <strong>Pozycja:</strong> ${plate.position || 'N/A'}
              ${plate.image ? `<br><img src="${plate.image}" class="plate-image" alt="Obraz tablicy ${i+1}">` : ''}
            </div>`;
        });
      }

      // Pojazdy
      if (shot_results.vehicles && shot_results.vehicles.length > 0) {
        vehiclesHtml = '<h4>üöó Wykryte pojazdy:</h4>';
        shot_results.vehicles.forEach((vehicle, i) => {
          vehiclesHtml += `
            <div class="vehicle-result">
              <strong>Pojazd ${i+1}:</strong><br>
              <strong>Marka:</strong> ${vehicle.make || 'N/A'} | 
              <strong>Model:</strong> ${vehicle.model || 'N/A'}<br>
              <strong>Typ:</strong> ${vehicle.type || 'N/A'} | 
              <strong>Kolor:</strong> ${vehicle.color || 'N/A'}<br>
              <strong>Pewno≈õƒá:</strong> ${(vehicle.confidence * 100).toFixed(1)}% | 
              <strong>Prƒôdko≈õƒá:</strong> ${vehicle.speed || '0'} km/h
            </div>`;
        });
      }

      detailsText = `=== SZCZEG√ì≈ÅOWE WYNIKI NCSHOT ===\n\n`;
      detailsText += `Status przetwarzania: ${shot_results.summary?.processing_successful ? 'SUKCES' : 'B≈ÅƒÑD'}\n`;
      detailsText += `Liczba wykrytych tablic: ${shot_results.summary?.plates_detected || 0}\n`;
      detailsText += `Liczba wykrytych pojazd√≥w: ${shot_results.summary?.vehicles_detected || 0}\n`;
      detailsText += `Token u≈ºyty: ${results.token_used || 'N/A'}\n`;
      detailsText += `SSH Tunnel: ${results.tunnel_info || 'N/A'}\n\n`;

      if (shot_results.timestamp) {
        detailsText += `Znacznik czasu: ${shot_results.timestamp.formatted || 'N/A'}\n\n`;
      }

      rawData = results.xml_response || 'Brak danych XML.';

    } else {
        summaryHtml = `<div class="result-error">‚ùå Nieznany format odpowiedzi: ${results.verification_type}</div>`;
        detailsText = JSON.stringify(results, null, 2);
        rawData = JSON.stringify(results, null, 2);
    }

    return { summaryHtml, detailsText, rawData, platesHtml, vehiclesHtml, tunnelInfoHtml };
  }

  async function generatePackage(){
    if(editPoly) toggleEdit();
    const rois = roisOut();
    if(!rois.length) return notyf.error('Brak ROI');

    const deployment = {
      serialNumber:$('serial-number').value,
      locationId:$('location-id').value,
      gpsLat:$('gps-lat').value,
      gpsLon:$('gps-lon').value,
      backendAddr:$('backend-addr').value,
      swdallowMasks:$('swdallow-masks').value,
      nativeallowMasks:$('nativeallow-masks').value
    };
    if(!deployment.locationId) return notyf.error('Wymagane ID lokalizacji');

    showLoader();
    try{
      const res = await fetch('/generate-package/', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ rois, deployment }) });
      if(!res.ok) { const err = await res.json(); throw new Error(err.detail || 'B≈ÇƒÖd serwera'); }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url;
      a.download=`ncpy_package_${deployment.locationId}_${new Date().toISOString().slice(0,10)}.zip`;
      a.click();
      URL.revokeObjectURL(url);
      notyf.success('Pobrano pakiet');
    }catch(e){ notyf.error(e.message); } finally{ hideLoader(); }
  }

  async function verifyScene(){
    await runVerification('/verify-scene/', 'NCSim', 'üî¨');
  }

  async function verifySceneNcshot(){
    await runVerification('/verify-scene-ncshot/', 'NCShot', 'üéØ');
  }

  function getPackageData(){
    if(editPoly) toggleEdit();
    const rois = roisOut();
    const deployment = {
      serialNumber: $('serial-number').value,
      locationId: $('location-id').value,
      gpsLat: $('gps-lat').value,
      gpsLon: $('gps-lon').value,
      backendAddr: $('backend-addr').value,
      swdallowMasks: $('swdallow-masks').value,
      nativeallowMasks: $('nativeallow-masks').value
    };
    return { rois, deployment };
  }

  async function runVerification(endpoint, methodName, icon){
    const packageData = getPackageData();
    const rois = packageData.rois;
    
    if(!rois.length) return notyf.error('Dodaj ROI przed weryfikacjƒÖ');

    if (!canvas.backgroundImage) {
        return notyf.error(`Za≈Çaduj obraz t≈Ça, aby uruchomiƒá weryfikacjƒô ${methodName}.`);
    }

    const terminalIp = $('device-ip').value;
    if(!terminalIp) return notyf.error('Podaj IP terminala');

    const payload = {
      package: packageData,
      password: $('device-pass').value,
      terminal_ip: terminalIp,
      image_base64: canvas.toDataURL()
    };

    $('panel-verify').style.display='block';
    $('verify-summary').innerHTML = `<div style="color: #2196f3;">${icon} Uruchamiam weryfikacjƒô ${methodName}...</div>`;
    $('verify-details').textContent = `≈ÅƒÖczenie z terminalem ${terminalIp}, przygotowywanie ≈õrodowiska...`;
    $('verify-raw').textContent = 'Oczekiwanie na dane...';
    $('verify-plates').innerHTML = '';
    $('verify-vehicles').innerHTML = '';
    $('verify-tunnel-info').innerHTML = '';

    showLoader();
    try{
      const res = await fetch(endpoint, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      });
      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.detail || 'Nieznany b≈ÇƒÖd serwera');
      }

      if (data.success && data.parsed_recognition_data) {
        const formatted = formatVerificationResults(data.parsed_recognition_data);
        $('verify-summary').innerHTML = formatted.summaryHtml;
        $('verify-details').textContent = formatted.detailsText;
        $('verify-raw').textContent = formatted.rawData;
        $('verify-plates').innerHTML = formatted.platesHtml;
        $('verify-vehicles').innerHTML = formatted.vehiclesHtml;
        $('verify-tunnel-info').innerHTML = formatted.tunnelInfoHtml;
        notyf.success(`Weryfikacja ${methodName} zako≈Ñczona`);
      } else {
        $('verify-summary').innerHTML = `<div class="result-error">‚ùå B≈ÇƒÖd przetwarzania wynik√≥w ${methodName}</div>`;
        $('verify-details').textContent = `B≈ÇƒÖd: ${data.error || 'Brak danych'}`;
        $('verify-raw').textContent = JSON.stringify(data, null, 2);
        notyf.error(`B≈ÇƒÖd podczas weryfikacji ${methodName}`);
      }

    }catch(e){
      $('verify-summary').innerHTML = `<div class="result-error">‚ùå B≈ÇƒÖd krytyczny: ${e.message}</div>`;
      $('verify-details').textContent = 'Sprawd≈∫ konsolƒô przeglƒÖdarki i logi serwera FastAPI, aby uzyskaƒá wiƒôcej informacji.';
      $('verify-raw').textContent = `Error: ${e.message}\nEndpoint: ${endpoint}`;
      notyf.error(`Weryfikacja ${methodName} nieudana: ` + e.message, {duration: 6000});
    }finally{
      hideLoader();
    }
  }
</script>
</body>
</html>
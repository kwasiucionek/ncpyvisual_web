# NCPyVisual Web - Architektura Systemu

## ğŸ—ï¸ Poprawiona architektura (NCShot lokalnie na terminalach)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Browser   â”‚    â”‚   Jump Host     â”‚    â”‚   Terminal      â”‚
â”‚   localhost:8000â”‚    â”‚ 10.10.33.113   â”‚    â”‚ 172.16.3.13    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                      â”‚                      â”‚
          â”‚ HTTP Request         â”‚                      â”‚
          â”‚ (ROI + Image)        â”‚                      â”‚
          â–¼                      â”‚                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                      â”‚
â”‚ FastAPI Server  â”‚              â”‚                      â”‚
â”‚ (Python)        â”‚              â”‚                      â”‚
â”‚                 â”‚              â”‚                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚                      â”‚
â”‚ â”‚ NCShot      â”‚ â”‚ SSH Tunnel   â”‚                      â”‚
â”‚ â”‚ Handler     â”‚ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚                      â”‚ port 5543
â”‚                 â”‚              â”‚                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚              â”‚                      â”‚ â”‚   NCShot    â”‚
â”‚ â”‚ NCSim       â”‚ â”‚ SSH Exec     â”‚                      â”‚ â”‚  (HTTP API) â”‚
â”‚ â”‚ Handler     â”‚ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚              â”‚                      â”‚ port 22
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                      â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚                      â”‚ â”‚    SSH      â”‚
                                 â”‚                      â”‚ â”‚  (NCSim)    â”‚
                                 â”‚                      â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ Flow procesÃ³w

### **NCShot Process Flow:**
```
1. [FastAPI] PoÅ‚Ä…cz SSH â†’ Jump Host
2. [FastAPI] PoÅ‚Ä…cz SSH â†’ Terminal (przez Jump)  
3. [FastAPI] UtwÃ³rz SSH tunnel â†’ localhost:random â†’ terminal:5543
4. [FastAPI] HTTP PUT config â†’ tunnel â†’ NCShot  
5. [FastAPI] HTTP PUT image â†’ tunnel â†’ NCShot
6. [NCShot] Przetworz obraz â†’ ZwrÃ³Ä‡ XML + token
7. [FastAPI] HTTP GET plates images â†’ tunnel â†’ NCShot
8. [FastAPI] HTTP GET release token â†’ tunnel â†’ NCShot
9. [FastAPI] Zamknij tunnel i SSH connections
10. [FastAPI] ZwrÃ³Ä‡ parsed results â†’ Browser
```

### **NCSim Process Flow:**
```
1. [FastAPI] PoÅ‚Ä…cz SSH â†’ Jump Host
2. [FastAPI] PoÅ‚Ä…cz SSH â†’ Terminal (przez Jump)
3. [FastAPI] SFTP copy â†’ ncsim binary + config + image + syntax
4. [FastAPI] SSH exec â†’ cd /tmp && ./ncsim -mconfig.ini image.jpg  
5. [NCSim] Przetworz â†’ Output text (recog-strong%, recog-weak%)
6. [FastAPI] Pobierz output + WyczyÅ›Ä‡ /tmp files
7. [FastAPI] Zamknij SSH connections  
8. [FastAPI] ZwrÃ³Ä‡ parsed results â†’ Browser
```

## ğŸŒ Network Requirements

### **DostÄ™p sieciowy:**
- **Browser** â†’ **FastAPI Server**: HTTP/8000 (localhost)
- **FastAPI Server** â†’ **Jump Host**: SSH/22 (10.10.33.113)
- **Jump Host** â†’ **Terminal**: SSH/22 + HTTP/5543 (172.16.3.x)

### **Credentials required:**
- **Jump Host**: `JUMP_HOST_USER` + `JUMP_HOST_PASS` (w .env)
- **Terminal**: `root` + `device_password` (z formularza)

## ğŸ“Š PorÃ³wnanie metod

| **Aspekt** | **ğŸ¯ NCShot** | **ğŸ”¬ NCSim** |
|------------|---------------|--------------|
| **ProtokÃ³Å‚** | HTTP przez SSH tunnel | SSH exec |
| **Czas wykonania** | ~5-8s | ~10-15s |
| **Wyniki** | PeÅ‚ny XML + obrazy | Tylko procenty |
| **Zasoby** | UÅ¼ywa NCShot daemon | Tworzy temp environment |
| **StabilnoÅ›Ä‡** | Stabilny (HTTP API) | ZaleÅ¼y od plikÃ³w binary |
| **Debugging** | HTTP status codes | SSH output parsing |

## ğŸ”§ Konfiguracja Å›rodowiska

### **Terminal requirements:**
```bash
# NCShot daemon running:
systemctl status ncshot  # should be active
netstat -tlpn | grep :5543  # NCShot listening

# NCSim requirements:  
ls -la /neurocar/etc/syntax/  # syntax files
ls -la /neurocar/etc/classreco77k-2016-07-29.dta  # DTA file
```

### **FastAPI server requirements:**
```bash
# Binary file:
bin/ncsim  # executable file (chmod +x)

# SSH credentials:
.env file with JUMP_HOST_USER and JUMP_HOST_PASS

# Python dependencies:
pip install -r requirements.txt
```

## ğŸš¨ Troubleshooting Points

### **Connection failures:**
1. **Jump Host unreachable** â†’ Check VPN/network
2. **Terminal unreachable** â†’ Check terminal IP/status  
3. **NCShot not responding** â†’ Check systemctl status ncshot
4. **SSH tunnel fails** â†’ Check port 5543 availability

### **Performance issues:**
1. **NCShot slow** â†’ Terminal overloaded or network latency
2. **NCSim slow** â†’ File transfer time or syntax loading
3. **Tunnel timeout** â†’ Increase NCSHOT_TIMEOUT in .env

### **Authentication issues:**
1. **Jump Host auth fails** â†’ Check JUMP_HOST_USER/PASS in .env
2. **Terminal auth fails** â†’ Check device password in form
3. **Permission denied** â†’ Check SSH key/password auth methods

---

**Key Architecture Change**: NCShot runs **locally on each terminal** (port 5543), accessed via **SSH tunnel through jump host**, not on central server.
